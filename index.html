<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WAXTax</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython.min.js">
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython_stdlib.min.js">
        </script>

        <link rel="icon" href="img/favicon-32x32.png">

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <style>
            .b-example-divider {
                height: 3rem;
                background-color: rgba(0, 0, 0, .1);
                border: solid rgba(0, 0, 0, .15);
                border-width: 1px 0;
                box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
            }
            

        </style>
    </head>
    <body onload="brython()">

            <div class="bg-dark text-secondary px-4 py-5 text-center">
                <div class="py-5">
                    <img class="d-block mx-auto mb-4" src="img/gold stamp.png" alt="" width="72" height="72">
                    <h1 class="display-5 fw-bold text-white">WAXTax (Beta)</h1>
                    <div class="col-lg-6 mx-auto">
                        <p class="fs-5 mb-4">Get your WAX transactions in an easy to reconcile format.</p>
                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                            <a href="#data-form"><button type="button" class="btn btn-outline-info btn-lg px-4 me-sm-3 fw-bold">Get my transactions!</button></a>
                            <a href="#see-how-it-works"><button type="button" class="btn btn-outline-secondary btn-lg px-4">See how it works</button></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="px-4 py-5 my-5 text-center">
            <div class="col-lg-6 mx-auto">
                <p>Enter your address and date range below, then click the "Submit" button. It is recommended not using a date in the last 7 days, as it can take the API endpoints some time to update.</p> 
                <p>The website will search for transactions and then collate them into a format that can be copied into a spreadsheet.
                    The output includes date and time, block number, transaction ID, and WAX and USD values of the transactions.
                    This may take a while depending on your date range and number of transactions, but "shouldn't" break.
                After the processing is complete, click "Copy" to copy the output to your clipboard.</p>
                <p>Support for AtomicAsset Transfers is coming soon!</p>
                <br>
                <p>Transaction missing? Please log it <a href="https://forms.gle/v9Z7kynrzAxiuDv86">here</a> so we can investigate.</p>
            </div>
            </div>
          <div class="b-example-divider"></div>
          <a id="data-form"/>
          <div class="container col-xl-10 col-xxl-8 px-4 py-5">
            <div class="row align-items-center g-5 py-5">
                <h1>Enter your address and date range</h1>
              <div class="col-lg-7 text-center text-lg-start">
                <form>
                    <label for="basic-url" class="form-label">We don't store your WAX address, nor will we send it unwanted airdrops.</label>

                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">WAX Address</span>
                        <input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1" id="wax-address">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Start Date (UTC)</span>
                        <input type="datetime-local" id="start_date_input">
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">End Date (UTC)</span>
                        <input type="datetime-local" id="end_date_input">
                        <p class="text-muted">I recommend a month at a time, or a week at a time if you are a high trade volume account (or play any of the dApp games such as AlienWorlds)</p>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Compare to</span>
                        <select class="form-select" aria-label="Default select example" id="currency_select">
                            <!-- <option selected>Choose a currency</option> -->
                            <option value="usd">USD</option>
                            <option value="btc">BTC</option>
                            <option value="eth">ETH</option>
                            <option value="ltc">LTC</option>
                            <option value="bch">BCH</option>
                            <option value="bnb">BNB</option>
                            <option value="eos">EOS</option>
                            <option value="xrp">XRP</option>
                            <option value="xlm">XLM</option>
                            <option value="link">LINK</option>
                            <option value="dot">DOT</option>
                            <option value="yfi">YFI</option>
                            <option value="aed">AED</option>
                            <option value="ars">ARS</option>
                            <option value="aud">AUD</option>
                            <option value="bdt">BDT</option>
                            <option value="bhd">BHD</option>
                            <option value="bmd">BMD</option>
                            <option value="brl">BRL</option>
                            <option value="cad">CAD</option>
                            <option value="chf">CHF</option>
                            <option value="clp">CLP</option>
                            <option value="cny">CNY</option>
                            <option value="czk">CZK</option>
                            <option value="dkk">DKK</option>
                            <option value="eur">EUR</option>
                            <option value="gbp">GBP</option>
                            <option value="hkd">HKD</option>
                            <option value="huf">HUF</option>
                            <option value="idr">IDR</option>
                            <option value="ils">ILS</option>
                            <option value="inr">INR</option>
                            <option value="jpy">JPY</option>
                            <option value="krw">KRW</option>
                            <option value="kwd">KWD</option>
                            <option value="lkr">LKR</option>
                            <option value="mmk">MMK</option>
                            <option value="mxn">MXN</option>
                            <option value="myr">MYR</option>
                            <option value="ngn">NGN</option>
                            <option value="nok">NOK</option>
                            <option value="nzd">NZD</option>
                            <option value="php">PHP</option>
                            <option value="pkr">PKR</option>
                            <option value="pln">PLN</option>
                            <option value="rub">RUB</option>
                            <option value="sar">SAR</option>
                            <option value="sek">SEK</option>
                            <option value="sgd">SGD</option>
                            <option value="thb">THB</option>
                            <option value="try">TRY</option>
                            <option value="twd">TWD</option>
                            <option value="uah">UAH</option>
                            <option value="vef">VEF</option>
                            <option value="vnd">VND</option>
                            <option value="zar">ZAR</option>
                            <option value="xdr">XDR</option>
                            <option value="xag">XAG</option>
                            <option value="xau">XAU</option>
                            <option value="bits">BITS</option>
                            <option value="sats">SATS</option>
                          </select>    
                    </div>
                </form>
                <button id="submit-btn" class="btn btn-primary">Submit</button>
              </div>
              <div class="col-10 mx-auto col-lg-5">
                  <div class="input-group">
                      <textarea class="form-control" id="output" placeholder="Your text will appear here!" rows=5></textarea>
                      <button class="btn btn-outline-secondary" id="copy-btn" type="button">Copy!</button>
                    </div>
                <p id="trx-scanned">No transactions scanned yet.</p>
              </div>
            </div>
          </div>

    
          <div class="b-example-divider"></div>

          <div class="container py-5" id="featured-3">
            <h2 class="pb-2 border-bottom" id="see-how-it-works">How does it work?</h2>
            <div class="row g-5 py-5">
              <div class="feature col-md-4">
                  <img src="img/wax.png" class="img-fluid"/>
                  <p></p>
                  <h2>WAX</h2>
                  <p>First, we query the WAX API with your address and date range, looking at 100 transactions at a time. This may take a while, especially if you carry out many transactions.</p>
              </div>
              <div class="feature col-md-4">
                <img src="img/coingecko.png" class="img-fluid" style="zoom: 2"/>
                  <p></p>
                <h2>CoinGecko</h2>
                <p>Next, we get historical data from CoinGecko to calculate the value of transactions on the day they were carried out. At the moment, value is calculated in USD, with plans to support more currencies soon.</p>
              </div>
              <div class="feature col-md-4">
                <img src="img/excel.png" class="img-fluid"/>
                  <p></p>
                <h2>Spreadsheet</h2>
                <p>Finally, we process all the data into a format that can be easily copied into your favourite spreadsheet editor. Just paste it in and go!</p>
              </div>
            </div>
            <div class="alert alert-info" role="alert">
                <h3>Feedback or suggestions?</h3>
                Contact me on Twitter at <a href="https://twitter.com/stuckatsixpm" class="alert-link">@stuckatsixpm</a>
                <p></p>
                <h3>Find WaxTax useful?</h3>
                Consider supporting me by sending some WAX to the address <kbd>stuckatsixpm</kbd>. Alternatively, check out my NFT projects <a href="https://sixpm.dev" class="alert-link">here.</a>
              </div>
              <hr>
              <div class="row  g-5 py-5">
                <div class="col-md-5 align-text-top">
                    <h2>Upcoming features</h2>
                    <ul>
                        <li>Support for other currencies</li>
                        <li>Support for timezones</li>
                        <li>Support for Atomic Asset transfers</li>
                    </ul>
                </div>
                <div class="col-md-5 align-text-top">
                    <h2>Acknowledgements</h2>
                    <p>Thanks to:</p>
                    <ul>
                        <li>The WAX.io team</li>
                        <li>WAXSweden</li>
                        <li>CoinGecko</li>
                        <li>Everyone who has supported this project</li>
                    </ul>
                </div>
                </div>
          </div>
          <div class="b-example-divider"></div>

         
        <footer class="footer mt-auto py-3 bg-light">
            <div class="container">
              <span class="text-muted">Built in Python with ❤️ by stuckatsixpm</span>
            </div>
        </footer>

        <script type="text/python" id="script3">
            import base64
            import calendar
            import csv
            import datetime
            import json
            import time
            from operator import itemgetter

            from browser import document, ajax, html, aio
            import browser.timer

            global scan_round
            scan_round = 1
            
            global transactions
            transactions = []

            global skip
            skip = 0

            def dt2ts(dt):
                """Converts a datetime object to UTC timestamp

                naive datetime will be considered UTC.

                """

                return calendar.timegm(dt.utctimetuple())

            async def process():
                global transactions
                req = ajax.ajax()
                currency = document['currency_select'].value
                print(currency)
                url = f"https://api.coingecko.com/api/v3/coins/wax/market_chart?vs_currency={currency}&days=max"
                req.open('GET', url, False)
                req.send()
                history = dict(json.loads(req.responseText)['prices'])
                output = []
                headers = ["timestamp","block","contract","from","to","wax","wax_historical","value_at_date","trx_id","data"]
                for i in transactions:
                    row = []
                    row.append(str(i['timestamp']))
                    row.append(str(i['block_num']))
                    row.append(str(i['act']['account'])+" - "+str(i['act']['name']))
                    data = i['act']['data']
                    if i['act']['name'] == "transfer":
                        row.append(data['from'])
                        row.append(data['to'])
                    else:
                        row.append("N/A")
                        row.append("N/A")
                    if data.get("amount",False) and data.get("symbol",False)=="WAX":
                        row.append(data['amount'])
                        date = datetime.datetime.fromisoformat(i['timestamp'].split("T")[0])
                        date = dt2ts(date)*1000
                        price = history.get(date,False)
                        if price:
                            value = history[date]*float(data['amount'])
                            row.append(f"{currency.upper()}{round(price,5)}")
                            row.append(f"{round(value,5)}")
                        else:
                            row.append(f"No Data")
                            row.append(f"No Data")
                    else:
                        row.append("N/A")
                        row.append("N/A")
                        row.append("N/A")
                    row.append(str(i['trx_id']))
                    row.append(str(data))
                    output.append([str(val) for val in row])
                output = sorted(output, key=itemgetter(0))
                output = [headers]+output
                output = ["\t".join(row) for row in output]
                mega_string = "\n".join(output)
                document['output'].value = mega_string
                document['trx-scanned'].text = f"{len(transactions)} transactions scanned. Hit copy to send the output to the clipboard!"
                transactions = []

                
                    
                

            async def request():
                account = document['wax-address'].value
                start_date = document['start_date_input'].value
                end_date = document['end_date_input'].value
                global skip
                global scan_round
                endpoints = ["https://api.wax.alohaeos.com/v2/history/get_actions"]
                temp_transactions = []
                for endpoint in endpoints:
                    skip = 0
                    scan_round = 1
                    while True:
                        try:
                            req = ajax.ajax()
                            url = f'{endpoint}?account={account}&skip={skip}&after={start_date}&before={end_date}&limit=100&sort=asc'
                            req.open('GET', url, False)
                            req.send()
                            new = json.loads(req.responseText)['actions']
                        except:
                            await aio.sleep(10)
                            continue
                        temp_transactions.extend(new)
                        print(len(temp_transactions),"transactions scanned")
                        if len(new) < 100:
                            print("Done")
                            break
                        else:
                            skip += 100
                            await aio.sleep(0.5)
                            scan_round += 1
                for i in temp_transactions:
                    if i not in transactions:
                        transactions.append(i)
                await aio.run(process())

            def copy_func(e):
                document['output'].focus()
                document['output'].select()
                document.execCommand("copy")
            document['copy-btn'].bind('click',copy_func)
            document['submit-btn'].bind("click",lambda e:aio.run(request()))

        </script>
        <!-- Option 1: Bootstrap Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

    </body>
</html> 
